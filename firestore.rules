rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if the user ID matches the authenticated user
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ============================================
    // PER-USER COLLECTIONS
    // ============================================
    
    // User document - users can only access their own document
    match /users/{userId} {
      // Users can only read/write their own user document
      allow read, write: if isOwner(userId);
      
      // User's videos subcollection - users can only access their own videos
      match /videos/{videoId} {
        allow read, write: if isOwner(userId);
      }
      
      // User's categories subcollection - users can only access their own categories
      match /categories/{categoryId} {
        allow read, write: if isOwner(userId);
      }
      
      // User's favorites subcollection - users can only access their own favorites
      match /favorites/{videoId} {
        allow read, write: if isOwner(userId);
      }
      
      // ═══════════════════════════════════════════════════════════════════
      // WATCH-TIME DATA - FIREBASE ENFORCED RULES
      // ═══════════════════════════════════════════════════════════════════
      // User's watch-time data - users can only access their own data
      // NEW: Firebase enforces: max 120 minutes effective time, wallet max 180 minutes, reset rules
      match /watchTimeData/data {
        // Allow read/write only to authenticated user's own data
        allow read, write: if isOwner(userId);
        
        // NEW: Enforce maximum limits on updates (Firebase enforcement)
        // Effective time (base + applied) max = 120 minutes (2 hours)
        // Wallet max = 180 minutes (3 hours)
        allow update: if isOwner(userId) &&
                       request.resource.data.baseTime is int && 
                       request.resource.data.baseTime >= 1 && 
                       request.resource.data.baseTime <= 120 &&
                       request.resource.data.appliedExtraTime is int && 
                       request.resource.data.appliedExtraTime >= 0 && 
                       request.resource.data.appliedExtraTime <= 120 &&
                       request.resource.data.walletTime is int && 
                       request.resource.data.walletTime >= 0 && 
                       request.resource.data.walletTime <= 180 &&
                       (request.resource.data.baseTime + request.resource.data.appliedExtraTime) <= 120 &&
                       request.resource.data.resetAdCount is int &&
                       request.resource.data.resetAdCount >= 0 &&
                       request.resource.data.resetAdCount <= 3;
        
        // NEW: Allow create with same validation (120 min effective, 180 min wallet)
        allow create: if isOwner(userId) &&
                        request.resource.data.baseTime is int && 
                        request.resource.data.baseTime >= 1 && 
                        request.resource.data.baseTime <= 120 &&
                        request.resource.data.appliedExtraTime is int && 
                        request.resource.data.appliedExtraTime >= 0 && 
                        request.resource.data.appliedExtraTime <= 120 &&
                        request.resource.data.walletTime is int && 
                        request.resource.data.walletTime >= 0 && 
                        request.resource.data.walletTime <= 180 &&
                        (request.resource.data.baseTime + request.resource.data.appliedExtraTime) <= 120;
      }
    }
    
    // ============================================
    // GLOBAL COLLECTIONS (Shared across users)
    // ============================================
    
    // Video requests - per-user isolation
    // Each user can only access their own video requests
    match /video_requests/{requestId} {
      // Users can only read their own requests
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Users can only create requests with their own userId
      allow create: if isAuthenticated() 
                    && request.resource.data.userId == request.auth.uid;
      
      // Users can only update their own requests
      // Allow update only to change status to APPROVED or REJECTED
      allow update: if isAuthenticated() 
                    && resource.data.userId == request.auth.uid
                    && (
                      request.resource.data.status == 'APPROVED' 
                      || request.resource.data.status == 'REJECTED'
                    );
      
      // Users can only delete their own requests
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Video cache - read for all (performance), write for authenticated
    // This is a global cache for YouTube search results
    match /video_cache/{cacheId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    // ============================================
    // SECURITY
    // ============================================
    
    // Deny all other access (security)
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

